#!/bin/bash

# Provider éš”ç¦»æµ‹è¯•è„šæœ¬
# éªŒè¯ XML è½¬æ¢åªå¯¹ Zhipu provider ç”Ÿæ•ˆ

echo "ğŸ§ª Testing Provider Isolation for XML Conversion"
echo "================================================"
echo ""

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ğŸ“‹ Test Scenarios:"
echo "--------------------------------"
echo ""
echo "1. âœ… Zhipu Provider + Standard Client"
echo "   â†’ Should convert XML to JSON"
echo ""
echo "2. âœ… Zhipu Provider + ZhipuNative Client"
echo "   â†’ Should preserve XML"
echo ""
echo "3. âœ… OpenAI Provider + Any Client"
echo "   â†’ Should NOT attempt XML conversion"
echo ""
echo "4. âœ… Anthropic Provider + Any Client"
echo "   â†’ Should NOT attempt XML conversion"
echo ""

echo "ğŸ“ Implementation Details:"
echo "--------------------------------"
echo ""
echo "The XML conversion logic now includes:"
echo ""
echo "1. Provider Check:"
echo "   if !is_zhipu {"
echo "     return; // Skip XML conversion"
echo "   }"
echo ""
echo "2. Configuration Check:"
echo "   if preserve_xml == true {"
echo "     return; // Skip XML conversion"
echo "   }"
echo ""
echo "3. XML Detection & Conversion:"
echo "   if xml::transform_xml_in_json_response(data) {"
echo "     // Convert XML to JSON"
echo "   }"
echo ""

echo "ğŸ” What to Look for in Logs:"
echo "--------------------------------"
echo ""
echo -e "${GREEN}For Zhipu Provider:${NC}"
echo "  â€¢ 'ğŸ” Checking for XML in Zhipu response...'"
echo "  â€¢ 'ğŸ”„ Successfully converted XML to JSON in response' (if XML found)"
echo "  â€¢ 'âœ“ No XML found in response' (if no XML)"
echo ""
echo -e "${YELLOW}For Non-Zhipu Providers:${NC}"
echo "  â€¢ 'â­ï¸  Skipping XML conversion: not a Zhipu provider'"
echo ""
echo -e "${YELLOW}For ZhipuNative Client:${NC}"
echo "  â€¢ 'â­ï¸  Skipping XML conversion: preserve_xml is enabled'"
echo "  â€¢ 'ğŸ”§ ZhipuNative adapter: preserving original XML format'"
echo ""

echo "ğŸ§ª Test Commands:"
echo "--------------------------------"
echo ""
echo "Test 1: Zhipu + Codex (should convert)"
echo -e "${YELLOW}RUST_LOG=debug ./target/release/llm-link --app codex-cli${NC}"
echo ""
echo "Test 2: Zhipu + ZhipuNative (should preserve)"
echo -e "${YELLOW}curl -H 'x-client: zhipu-native' http://localhost:8088/v1/chat/completions${NC}"
echo ""
echo "Test 3: OpenAI provider (should skip)"
echo "   â†’ Configure with OpenAI backend, check logs for skip message"
echo ""

echo "================================================"
echo -e "${GREEN}âœ… Provider isolation is implemented!${NC}"
echo ""
echo "Key Points:"
echo "  â€¢ XML conversion ONLY happens for Zhipu provider"
echo "  â€¢ Other providers (OpenAI, Anthropic, etc.) are NOT affected"
echo "  â€¢ Safe to use with any LLM provider"
echo ""

