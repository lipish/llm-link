name: release-binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-matrix:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-13
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: sudo apt-get update && sudo apt-get install -y musl-tools pkg-config libssl-dev

      - name: Build release binary
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Package artifact
        run: |
          ARTIFACT="llm-link-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir -p dist/$ARTIFACT
          cp target/${{ matrix.target }}/release/llm-link dist/$ARTIFACT/
          cp LICENSE README.md dist/$ARTIFACT/
          tar -C dist -czf "$ARTIFACT.tar.gz" "$ARTIFACT"
          shasum -a 256 "$ARTIFACT.tar.gz" > "$ARTIFACT.tar.gz.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llm-link-${{ matrix.target }}
          path: |
            llm-link-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
            llm-link-${{ github.ref_name }}-${{ matrix.target }}.tar.gz.sha256

  publish-release:
    needs: build-matrix
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Display artifacts
        run: ls -R dist

      - name: Extract shasums
        id: shas
        run: |
          ARM64_SHA=$(cat dist/llm-link-aarch64-apple-darwin/llm-link-*.tar.gz.sha256 | awk '{print $1}')
          INTEL_SHA=$(cat dist/llm-link-x86_64-apple-darwin/llm-link-*.tar.gz.sha256 | awk '{print $1}')
          LINUX_SHA=$(cat dist/llm-link-x86_64-unknown-linux-gnu/llm-link-*.tar.gz.sha256 | awk '{print $1}')
          echo "arm64_sha=$ARM64_SHA" >> $GITHUB_OUTPUT
          echo "intel_sha=$INTEL_SHA" >> $GITHUB_OUTPUT
          echo "linux_sha=$LINUX_SHA" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: lipish/homebrew-llm-link
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap-repo

      - name: Update Homebrew formula
        env:
          ARM64_SHA: ${{ steps.shas.outputs.arm64_sha }}
          INTEL_SHA: ${{ steps.shas.outputs.intel_sha }}
          LINUX_SHA: ${{ steps.shas.outputs.linux_sha }}
        run: |
          FORMULA_PATH=tap-repo/Formula/llm-link.rb
          chmod +x scripts/update-homebrew-formula.sh
          ./scripts/update-homebrew-formula.sh "${GITHUB_REF_NAME#v}" "$FORMULA_PATH" "$ARM64_SHA" "$INTEL_SHA" "$LINUX_SHA"

      - name: Commit & push tap update
        env:
          VERSION: ${GITHUB_REF_NAME#v}
        run: |
          cd tap-repo
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add Formula/llm-link.rb
            git commit -m "llm-link ${VERSION}"
            git push origin HEAD:main
          else
            echo "No changes to tap repo"
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/**/llm-link-*.tar.gz
            dist/**/llm-link-*.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
